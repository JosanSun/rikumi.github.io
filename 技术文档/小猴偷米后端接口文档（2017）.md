# 小猴偷米后端接口文档（2017）

## 架构简述

小猴偷米后端服务器由一个**爬虫集**和一个**持久认证层**组成。

**爬虫集**即目前系统中的WebService2.0服务，它提供各类不同接口，理想状态下，每个接口负责根据输入的一卡通号、密码等信息，爬取对应网站页面，将结果格式化为JSON并输出；**认证接口（auth）在爬虫集中的作用也仅限于验证用户名密码是否有效，以及提供Cookie。**实际使用中，由于部分页面调用了统一身份认证，我们把统一身份认证获取Cookie的逻辑写在auth中，其它爬虫直接通过调用auth来完成各页面的登录。爬虫集中的大多数爬虫都利用数据库进行数据缓存。爬虫集不对外暴露接口，而是暴露给持久认证层使用。

**持久认证层**即目前系统中的HeraldAuth服务，它是为了解决所有爬虫均需要输入一卡通号和密码的问题而设立的。持久认证层同样暴露一个auth接口，但该接口不仅封装了用户身份验证，同时也将认证成功的一卡通号和密码保存在数据库中，并生成唯一uuid（即会话Token）作为返回值。客户端保存uuid后，可使用uuid向持久认证层请求调用其他接口。持久认证层收到uuid后，使用对应的一卡通号和密码调用爬虫集，将取得的接口结果返回给客户端。

另外，为了防止恶意利用，持久认证层在认证时需要提供预先约定的`appid`以证明开发者身份。

因此，前端（含客户端及其他调用者，下同）需要首先通过持久认证层进行认证，获取uuid，然后将uuid保存在前端的持久化存储中，日后使用uuid调用其它接口。

## 接口统一说明

### 请求统一说明

|  | 说明 |
| --- | --- |
| 域名 | 均为`www.heraldstudio.com` |
| 方法 | 均为`POST` |
| 请求体编码 | 均为`urlencoded`（编码符合即可，可不带`Content-Type`头） |
| 请求体参数 | **除`auth`外均带`uuid`参数，以下文档中将省略** |

### 响应统一说明

|  | 说明 |
| --- | --- |
| `HTTP<400` | 成功调用，响应体如无特殊说明均为`json`编码 |
| `HTTP 400` | 参数错误或`uuid`无效 |
| `HTTP 401` | 密码错误，需要重新登录 |
| `HTTP 408` | 爬虫运行超时 |
| `HTTP 500` | 后端运行时错误 |

## 认证API

### 登录认证

POST `/uc/auth`

| Key | Value |
| --- | --- |
| `appid` | 内部约定值 |
| `user` | 一卡通号 |
| `password` | 统一身份认证密码 |

认证成功，直接返回`uuid`的值（本接口响应体无编码）

### 解除认证

POST `/uc/deauth`

本接口将销毁`uuid`，清除相关的各种服务端缓存，一般情况下不调用。

### 用户信息

POST `/api/user`



# 小猴偷米后端接口文档（2017）

## 架构简述

小猴偷米后端服务器由一个**爬虫集**和一个**持久认证层**组成。

**爬虫集**即目前系统中的WebService2.0服务，它提供各类不同接口，理想状态下，每个接口负责根据输入的一卡通号、密码等信息，爬取对应网站页面，将结果格式化为JSON并输出；**认证接口（auth）在爬虫集中的作用也仅限于验证用户名密码是否有效，以及提供Cookie。**实际使用中，由于部分页面调用了统一身份认证，我们把统一身份认证获取Cookie的逻辑写在auth中，其它爬虫直接通过调用auth来完成各页面的登录。爬虫集中的大多数爬虫都利用数据库进行数据缓存。爬虫集不对外暴露接口，而是暴露给持久认证层使用。

**持久认证层**即目前系统中的HeraldAuth服务，它是为了解决所有爬虫均需要输入一卡通号和密码的问题而设立的。持久认证层同样暴露一个auth接口，但该接口不仅封装了用户身份验证，同时也将认证成功的一卡通号和密码保存在数据库中，并生成唯一uuid（即会话Token）作为返回值。客户端保存uuid后，可使用uuid向持久认证层请求调用其他接口。持久认证层收到uuid后，使用对应的一卡通号和密码调用爬虫集，将取得的接口结果返回给客户端。

另外，为了防止恶意利用，持久认证层在认证时需要提供预先约定的`appid`以证明开发者身份。测试用的`appid`为`34cc6df78cfa7cd457284e4fc377559e`。

因此，前端（含客户端及其他调用者，下同）需要首先通过持久认证层进行认证，获取uuid，然后将uuid保存在前端的持久化存储中，日后使用uuid调用其它接口。

## 接口统一说明

### 请求统一说明

|       | 说明                                       |
| ----- | ---------------------------------------- |
| 域名    | 均为`www.heraldstudio.com`                 |
| 方法    | 均为`POST`                                 |
| 请求体编码 | 均为`urlencoded`（编码符合即可，可不带`Content-Type`头） |
| 请求体参数 | **除`auth`外均带`uuid`参数，以下文档中将省略**          |

### 响应统一说明

|            | 说明                       |
| ---------- | ------------------------ |
| `HTTP<400` | 成功调用，响应体如无特殊说明均为`json`编码 |
| `HTTP 400` | 参数错误或`uuid`无效            |
| `HTTP 401` | 密码错误，需要重新登录              |
| `HTTP 408` | 爬虫运行超时                   |
| `HTTP 500` | 后端运行时错误                  |

### 接口测试方法

以前一般用`Postman`测试接口，现在`Postman`越来越难用（可以说是越`Post`越慢），而且作为一个使用`Linux`的开发者，强烈建议掌握`curl`的用法：

![](http://static.myseu.cn/2017-09-25-075742.jpg)

用法：

```bash
curl http://www.example.com

可加参数：
  -X 请求方式
  -d key1=value1 (添加urlencoded格式的参数)
  -d key2=value2 (可以用多个-d添加多个参数)
  -d 'XiaoHou TouMi' (添加自定义的请求体，例如JSON字符串)
  -H key:value (添加请求头)
```

**目前调用小猴接口不需要任何请求头，但关于请求头的知识需要有所了解**，请求头一般需要跟请求体格式保持照应，例如用`urlencoded`格式编码的请求体（`key1=value1&key2=value2`）最好加上`Content-Type:application/x-www-form-urlencoded`头；用`JSON`编码的请求体最好加上`Content-Type:application/json`头。当然一部分后端程序并不会对请求头做校验。

## 认证API

### 登录认证

POST `/uc/auth`

| Key        | Value    |
| ---------- | -------- |
| `appid`    | 内部约定值    |
| `user`     | 一卡通号     |
| `password` | 统一身份认证密码 |

认证成功，直接返回`uuid`的值（本接口响应体无编码）。`uuid`不设过期时间，一经登录持久有效。

### 解除认证

POST `/uc/deauth`

本接口将销毁`uuid`，清除相关的各种服务端缓存，一般情况下不调用。

### 完善信息

POST `/uc/update`

| Key            | Requied | Value    |
| -------------- | ------- | -------- |
| `cardnum`      | 必填      | 一卡通号     |
| `password`     | 必填      | 统一身份认证密码 |
| `lib_username` | 选填      | 图书馆用户名   |
| `lib_password` | 选填      | 图书馆密码    |

### 用户信息

POST `/api/user`

响应报文：**（原为JSON格式，为了美观，这里用JS格式替代表示，注意语法区别，下同）**

```js
{
  content: {
    name: '于海通',
    sex: '男',
    cardnum: '213151933',
    schoolnum: '09015425'
  },
  code: 200
}
```

## 功能API

### 一卡通

POST `/api/card`

| Key       | Value                  |
| --------- | ---------------------- |
| timedelta | 查询天数（0/1/7/14/30），默认为0 |

注意：

1. `timedelta=0`表示只查询余额，`timedelta=1`查询余额和当日消费记录，这两个选项爬取速度较快；
2. 对于`timedelta=7`等选项，爬取速度较慢，而且**不含当日消费记录**，请慎用；
3. 查询消费记录的请求，返回报文中可能同时含有`detail`和`detial`字段，后者是拼写错误，为了兼容老版本而暂时存在，之后会考虑去掉；`left`和`cardLeft`字段同理；`system`和`mail`字段同理。

```js
{
  content: {
    left: '107.45',
    state: '正常',
    detail: [ // 仅 timedelta > 0 时有消费详情
      {
        price: '-2.00',
        system: '梅园一楼九阳豆浆',
        date: '2017/09/25 12:28:20',
        type: '持卡人消费',
        left: '109.45'
      }
    ]
  },
  code: 200
}
```

### 跑操次数

POST `/api/pe`

```js
{
  content: '40', // 已跑次数
  remain: '15', // 剩余工作日数
  rank: '67.89', // 排行百分比
  code: 200
}
```

### 跑操预告

POST `/api/pc`

```js
{
  content: '今天不跑操',
  code: 200
}
```

### 跑操详细记录

POST `/api/pedetail`

```js
{
  content: [
    
  ],
  code: 200
}
```

